# 代码补全服务器部署指南（中文版）

> **注意**：本文件为中文详细部署指南，英文快速入门请查看项目根目录的 [README.md](../README.md)

## 项目概述
基于Django的代码补全API服务器，为VSCode智能编码助手插件提供后端服务。使用DeepSeek API提供AI驱动的代码补全建议。

## 目录
- [系统要求](#系统要求)
- [快速开始](#快速开始)
- [生产环境部署](#生产环境部署)
- [错误处理](#错误处理)
- [监控和日志](#监控和日志)
- [性能优化](#性能优化)
- [安全建议](#安全建议)
- [故障排除](#故障排除)
- [更新和维护](#更新和维护)
- [支持文档](#支持文档)

## 系统要求
- **Python**: 3.14.1+
- **DeepSeek API密钥**: 从[DeepSeek官网](https://platform.deepseek.com/)获取
- **Pixi**: 用于依赖管理，[安装指南](https://pixi.sh/latest/)
- **操作系统**: Linux/macOS/Windows (WSL2推荐)

## 快速开始

### 1. 环境设置
```bash
# 克隆项目
git clone <repository-url>
cd codegen-server

# 安装Pixi（如果尚未安装）
# 参考：https://pixi.sh/latest/

# 使用pixi安装依赖
pixi install

# 设置DeepSeek API密钥（开发环境）
export DEEPSEEK_API_KEY="your-deepseek-api-key"
```

### 2. 数据库初始化
```bash
# 应用Django迁移
pixi run python manage.py migrate

# 可选：创建超级用户（用于Django管理后台）
pixi run python manage.py createsuperuser
```

### 3. 启动开发服务器
```bash
# 默认端口8000
pixi run python manage.py runserver

# 或指定端口
pixi run python manage.py runserver 8080

# 后台运行（使用nohup）
nohup pixi run python manage.py runserver 0.0.0.0:8000 > django.log 2>&1 &
```

### 4. 验证安装
```bash
# 运行完整测试套件
pixi run python test_api_final.py

# 或运行简化测试
pixi run python test_api_simple.py

# 测试API端点
curl -X POST http://localhost:8000/api/v1/completion \
  -H "Content-Type: application/json" \
  -d '{"prompt": "def hello():", "suffix": ""}'
```

## 生产环境部署

### 1. 生产环境配置

#### 环境变量配置
创建 `.env` 文件在生产服务器上：

```bash
# .env 文件内容
DEEPSEEK_API_KEY=your-production-api-key
DJANGO_SETTINGS_MODULE=api.settings
DEBUG=False
SECRET_KEY=your-secret-key-here  # 使用 django-admin startproject 生成
ALLOWED_HOSTS=your-domain.com,localhost,127.0.0.1
DATABASE_URL=sqlite:///db.sqlite3  # 或使用 PostgreSQL/MySQL
```

#### 安全设置
在 `api/settings.py` 中确保以下设置：

```python
# 生产环境安全设置
DEBUG = False
SECURE_SSL_REDIRECT = True  # 如果使用 HTTPS
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
```

### 2. 使用 Gunicorn 部署

#### 安装和配置
```bash
# 安装 gunicorn
pixi add --pypi gunicorn

# 创建 systemd 服务文件
sudo nano /etc/systemd/system/codegen-server.service
```

#### Systemd 服务配置
```ini
[Unit]
Description=Code Completion API Server
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/home/niclas/codegen-server
Environment="DEEPSEEK_API_KEY=your-api-key"
Environment="DJANGO_SETTINGS_MODULE=api.settings"
ExecStart=/home/niclas/codegen-server/.pixi/envs/default/bin/gunicorn \
    api.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers 4 \
    --threads 2 \
    --timeout 120 \
    --access-logfile /var/log/codegen-server/access.log \
    --error-logfile /var/log/codegen-server/error.log
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 启动服务
```bash
# 创建日志目录
sudo mkdir -p /var/log/codegen-server
sudo chown -R www-data:www-data /var/log/codegen-server

# 重新加载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start codegen-server

# 设置开机自启
sudo systemctl enable codegen-server

# 查看服务状态
sudo systemctl status codegen-server

# 查看日志
sudo journalctl -u codegen-server -f
```

### 3. Nginx 反向代理配置

#### 基本 Nginx 配置
```nginx
# /etc/nginx/sites-available/codegen-server
upstream codegen_server {
    server 127.0.0.1:8000;
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    
    # 静态文件（如果有）
    location /static/ {
        alias /home/niclas/codegen-server/codegen/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # 媒体文件（如果有）
    location /media/ {
        alias /home/niclas/codegen-server/codegen/media/;
        expires 30d;
    }
    
    # API 代理
    location / {
        proxy_pass http://codegen_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 缓冲区设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # CORS 配置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        
        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # 处理 OPTIONS 预检请求
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
    
    # 限制请求大小
    client_max_body_size 10M;
    
    # 访问日志
    access_log /var/log/nginx/codegen-server.access.log;
    error_log /var/log/nginx/codegen-server.error.log;
}
```

#### SSL/TLS 配置（使用 Let's Encrypt）
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 其余配置与上面相同...
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

#### 启用 Nginx 配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/codegen-server /etc/nginx/sites-enabled/

# 测试 Nginx 配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

## 监控和日志管理

### 日志文件位置
- **Django 日志**: `/var/log/codegen-server/error.log` (Gunicorn 配置)
- **Nginx 访问日志**: `/var/log/nginx/codegen-server.access.log`
- **Nginx 错误日志**: `/var/log/nginx/codegen-server.error.log`
- **Systemd 日志**: `sudo journalctl -u codegen-server`

### 日志查看命令
```bash
# 实时查看 Django 日志
sudo tail -f /var/log/codegen-server/error.log

# 查看 Nginx 访问日志
sudo tail -f /var/log/nginx/codegen-server.access.log

# 查看 Systemd 服务日志
sudo journalctl -u codegen-server -f --lines=100

# 查看特定时间段的日志
sudo journalctl -u codegen-server --since "2025-01-23" --until "2025-01-24"

# 查看错误级别的日志
sudo journalctl -u codegen-server -p err
```

### 健康检查
```bash
# 检查 API 端点是否响应
curl -I http://localhost:8000/api/v1/completion

# 详细健康检查
curl -X POST http://localhost:8000/api/v1/completion \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test", "suffix": "test"}'

# 检查服务器状态
sudo systemctl status codegen-server
sudo systemctl status nginx
```

## 性能调优

### 1. Gunicorn 配置优化
根据服务器资源调整配置：

```bash
# CPU 核心数
nproc

# 内存大小
free -h
```

推荐配置：
- **小型服务器** (1-2 CPU, 2-4GB RAM): `--workers 2 --threads 2`
- **中型服务器** (4 CPU, 8GB RAM): `--workers 4 --threads 4`
- **大型服务器** (8+ CPU, 16GB+ RAM): `--workers 8 --threads 4`

### 2. 数据库优化
```bash
# 使用 PostgreSQL 替代 SQLite（生产环境推荐）
# 在 api/settings.py 中配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'codegen_db',
        'USER': 'codegen_user',
        'PASSWORD': 'your-password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
```

### 3. 缓存配置（可选）
```python
# api/settings.py
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

## 安全加固

### 1. 防火墙配置
```bash
# 只开放必要端口
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 80/tcp      # HTTP
sudo ufw allow 443/tcp     # HTTPS
sudo ufw enable

# 查看防火墙状态
sudo ufw status verbose
```

### 2. 定期安全更新
```bash
# 系统更新
sudo apt update && sudo apt upgrade -y

# 重启服务
sudo systemctl restart codegen-server
sudo systemctl restart nginx
```

### 3. 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
BACKUP_DIR="/backup/codegen-server"
DATE=$(date +%Y%m%d_%H%M%S)

# 备份数据库
cp /home/niclas/codegen-server/codegen/db.sqlite3 $BACKUP_DIR/db_$DATE.sqlite3

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz \
  /home/niclas/codegen-server/pixi.toml \
  /home/niclas/codegen-server/.env \
  /etc/nginx/sites-available/codegen-server \
  /etc/systemd/system/codegen-server.service

# 保留最近7天的备份
find $BACKUP_DIR -type f -mtime +7 -delete

echo "备份完成: $DATE"
```

## 故障排除指南

### 常见问题及解决方案

#### 问题1: 服务器无法启动
```bash
# 检查错误信息
sudo journalctl -u codegen-server --no-pager -n 50

# 检查端口占用
sudo netstat -tlnp | grep :8000

# 检查文件权限
sudo ls -la /home/niclas/codegen-server/
sudo ls -la /var/log/codegen-server/

# 手动测试启动
cd /home/niclas/codegen-server
pixi run python manage.py check
pixi run python manage.py runserver 0.0.0.0:8000
```

#### 问题2: API 返回 500 错误
```bash
# 查看详细错误日志
sudo tail -f /var/log/codegen-server/error.log

# 检查 DeepSeek API 密钥
echo $DEEPSEEK_API_KEY

# 测试 DeepSeek API 连接
curl -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
  https://api.deepseek.com/beta/models

# 检查依赖是否完整
pixi list
```

#### 问题3: Nginx 502 Bad Gateway
```bash
# 检查 Gunicorn 是否运行
sudo systemctl status codegen-server

# 检查 Nginx 错误日志
sudo tail -f /var/log/nginx/codegen-server.error.log

# 测试直接连接 Gunicorn
curl http://127.0.0.1:8000/api/v1/completion

# 检查防火墙
sudo ufw status
```

#### 问题4: 内存不足
```bash
# 查看内存使用
free -h
top -o %MEM

# 查看进程内存使用
ps aux --sort=-%mem | head -10

# 调整 Gunicorn 配置（减少 workers）
sudo nano /etc/systemd/system/codegen-server.service
# 修改为: --workers 2 --threads 2
```

#### 问题5: 响应缓慢
```bash
# 检查网络延迟
ping api.deepseek.com

# 测试 API 响应时间
time curl -X POST http://localhost:8000/api/v1/completion \
  -H "Content-Type: application/json" \
  -d '{"prompt": "test", "suffix": "test"}'

# 调整超时时间
# 修改 completion/services.py 中的 DEFAULT_TIMEOUT
```

## 维护计划

### 每日检查
```bash
# 检查服务状态
sudo systemctl status codegen-server
sudo systemctl status nginx

# 检查磁盘空间
df -h

# 检查日志大小
sudo du -sh /var/log/codegen-server/
sudo du -sh /var/log/nginx/
```

### 每周维护
```bash
# 清理旧日志
sudo find /var/log/codegen-server/ -type f -name "*.log" -mtime +7 -delete
sudo find /var/log/nginx/ -type f -name "*.log" -mtime +7 -delete

# 备份数据库
./backup_script.sh

# 检查更新
pixi update
sudo apt update
```

### 每月维护
```bash
# 重启服务（应用更新）
sudo systemctl restart codegen-server
sudo systemctl restart nginx

# 检查安全更新
sudo apt list --upgradable

# 审查日志中的异常
sudo grep -i "error\|exception\|failed" /var/log/codegen-server/error.log | tail -50
```

## 扩展和定制

### 添加新的 API 端点
1. 在 `completion/views.py` 中添加新的视图函数
2. 在 `completion/urls.py` 中配置路由
3. 在 `completion/services.py` 中添加业务逻辑
4. 更新 `API文档.md` 中的 API 文档

### 修改代码补全逻辑
1. 编辑 `completion/services.py` 中的 `call_fim_api` 函数
2. 调整提示词工程（prompt engineering）
3. 修改参数验证逻辑
4. 更新错误处理

### 集成其他 AI 服务
1. 在 `pixi.toml` 中添加新的依赖
2. 创建新的服务模块
3. 修改视图以支持多 AI 提供商
4. 添加配置选项

## 联系和支持

### 文档资源
- **[README.md](../README.md)** - 英文快速入门指南
- **[API文档.md](./API文档.md)** - 完整 API 规范
- **[AGENTS.md](./AGENTS.md)** - AI 开发助手指南
- **[IFLOW.md](./IFLOW.md)** - 项目工作流说明

### 问题反馈
遇到问题时，请按以下步骤排查：

1. **检查日志**：查看相关错误日志
2. **验证配置**：确认环境变量和配置文件
3. **测试连接**：测试 API 端点和外部服务
4. **查阅文档**：参考相关文档和指南
5. **社区支持**：在项目 Issues 中提出问题

### 贡献指南
欢迎贡献代码和改进：
1. Fork 项目仓库
2. 创建功能分支
3. 提交更改
4. 创建 Pull Request
5. 确保代码通过测试

## 版本历史

### v1.0.0 (2026-01-23)
- 初始版本发布
- 基于 Django 的代码补全 API
- DeepSeek API 集成
- Pixi 依赖管理
- 完整的部署文档

### 未来计划
- 添加用户认证和授权
- 实现请求限流
- 添加监控仪表板
- 支持多 AI 提供商
- 优化缓存策略

---

*最后更新: 2026-01-23*  
*文档版本: v1.0.0*