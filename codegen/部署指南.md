# 代码补全服务器部署指南

## 项目概述
基于Django的代码补全API服务器，为VSCode智能编码助手插件提供后端服务。

## 系统要求
- Python 3.14.1+
- DeepSeek API密钥

## 快速开始

### 1. 环境设置
```bash
# 克隆项目（如果尚未克隆）
git clone <repository-url>
cd codegen-server/codegen

# 使用pixi安装依赖
pixi install

# 设置DeepSeek API密钥
export DEEPSEEK_API_KEY="your-deepseek-api-key"
```

### 2. 数据库初始化
```bash
# 应用Django迁移
pixi run python manage.py migrate
```

### 3. 启动服务器
```bash
# 开发模式（端口8000）
pixi run python manage.py runserver

# 或指定端口
pixi run python manage.py runserver 8080
```

### 4. 验证安装
```bash
# 测试API端点
pixi run python test_api.py
```

## API使用示例

### 基本请求
```bash
curl -X POST http://localhost:8000/api/v1/completion \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "int main() {\n    int a = 10;\n    int b = 20;\n    ",
    "suffix": "\n    return 0;\n}"
  }'
```

### 完整请求示例
```bash
curl -X POST http://localhost:8000/api/v1/completion \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "int main() {\n    int a = 10;\n    int b = 20;\n    ",
    "suffix": "\n    return 0;\n}",
    "includes": [
      "#include <iostream>",
      "#include <vector>"
    ],
    "other_functions": [
      {
        "name": "calculate_sum",
        "signature": "int calculate_sum(int a, int b)"
      },
      {
        "name": "calculate_product",
        "signature": "int calculate_product(int a, int b)"
      }
    ],
    "max_tokens": 100
  }'
```

## 生产环境部署

### 1. 环境变量配置
创建`.env`文件：
```bash
DEEPSEEK_API_KEY=your-production-api-key
DJANGO_SETTINGS_MODULE=api.settings
DEBUG=False
ALLOWED_HOSTS=your-domain.com,localhost
```

### 2. 使用Gunicorn
```bash
# 安装gunicorn
pixi add --pypi gunicorn

# 启动生产服务器
pixi run gunicorn api.wsgi:application \
  --bind 0.0.0.0:8000 \
  --workers 4 \
  --timeout 120
```

### 3. 使用Nginx反向代理
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # CORS配置
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type';
        
        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type';
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
}
```

## 错误处理

### 常见错误码
| 错误码 | 说明 | 解决方法 |
|--------|------|----------|
| INVALID_PARAMS | 请求参数缺失或格式错误 | 检查prompt和suffix参数是否提供 |
| INVALID_JSON | JSON格式无效 | 检查请求体是否为有效JSON |
| API_TIMEOUT | DeepSeek API调用超时 | 检查网络连接，增加超时时间 |
| API_CONNECTION_ERROR | 无法连接到DeepSeek API | 检查网络和API端点 |
| API_ERROR | DeepSeek API返回错误 | 检查API密钥和额度 |
| INTERNAL_ERROR | 服务器内部错误 | 查看服务器日志 |

### 错误响应示例
```json
{
  "success": false,
  "error_code": "INVALID_PARAMS",
  "error": "缺少必填参数: prompt"
}
```

## 监控和日志

### 查看日志
```bash
# Django开发服务器日志
tail -f /var/log/django.log

# Gunicorn日志
tail -f /var/log/gunicorn.log
```

### 健康检查
```bash
# 检查服务器是否运行
curl -I http://localhost:8000/api/v1/completion
```

## 性能优化

### 1. 调整超时时间
修改`completion/services.py`中的`DEFAULT_TIMEOUT`值。

### 2. 增加工作进程数
```bash
# Gunicorn配置
pixi run gunicorn api.wsgi:application --workers 8 --threads 4
```

### 3. 使用缓存（未来优化）
考虑添加Redis缓存重复请求。

## 安全建议

### 1. API密钥安全
- 永远不要将API密钥提交到版本控制
- 使用环境变量或密钥管理服务
- 定期轮换API密钥

### 2. 访问控制
- 生产环境限制ALLOWED_HOSTS
- 考虑添加API密钥认证
- 实施速率限制

### 3. CORS配置
- 生产环境指定具体域名而非`*`
- 仅允许必要的HTTP方法

## 故障排除

### 问题1：服务器无法启动
```bash
# 检查环境变量
echo $DEEPSEEK_API_KEY

# 检查端口占用
netstat -tlnp | grep :8000

# 检查Django配置
pixi run python manage.py check
```

### 问题2：API返回500错误
```bash
# 查看Django错误日志
pixi run python manage.py runserver

# 检查DeepSeek API密钥
curl -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
  https://api.deepseek.com/beta/models
```

### 问题3：CORS错误
```bash
# 测试OPTIONS请求
curl -X OPTIONS http://localhost:8000/api/v1/completion -i

# 检查响应头
curl -I http://localhost:8000/api/v1/completion
```

## 更新和维护

### 1. 更新依赖
```bash
# 更新pixi依赖
pixi update

# 更新Python包（通过pixi管理）
pixi install
```

### 2. 数据库维护
```bash
# 创建迁移文件
pixi run python manage.py makemigrations

# 应用迁移
pixi run python manage.py migrate

# 备份数据库
cp db.sqlite3 db.sqlite3.backup
```

### 3. 代码更新
```bash
# 拉取最新代码
git pull origin main

# 重启服务器
sudo systemctl restart gunicorn
```

## 支持

### 文档
- [API文档.md](./API文档.md) - 完整API规范
- [AGENTS.md](./AGENTS.md) - 开发指南

### 测试
```bash
# 运行完整测试套件（推荐）
pixi run python test_api_final.py

# 运行简化测试套件
pixi run python test_api_simple.py

# 运行原始测试脚本
pixi run python test_api.py

# 运行Django测试（当前无测试）
pixi run python manage.py test
```

### 问题反馈
遇到问题时：
1. 检查错误日志
2. 验证环境变量
3. 测试API端点
4. 查看相关文档

---

*最后更新: 2025-01-22*